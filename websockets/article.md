## Simplest HTTP server

```ts
import { createServer } from 'node:http';

const server = createServer((req, res) => {
  res.writeHead(200, { 'Content-Type': 'text/plain' });
  res.end('Hello, World!\n');
});

server.listen(8080, () => {
  console.log('Server listening on port 8080');
});
```

## First stage - WebSocket handshake over HTTP protocol

Client sends special HTTP request with special headers:

```yaml
GET /chat HTTP/1.1
Host: server.example.com
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: x3JJHMbDL1EzLkh9GBhXDw==
Sec-WebSocket-Protocol: chat, superchat
Sec-WebSocket-Version: 13
Origin: http://example.com
```

Server responds with headers:

```yaml
HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: HSmrc0sMlYUkAGmm5OPpG2HaGWk=
Sec-WebSocket-Protocol: chat
```

As you can see there are a few WS specific headers like: **Sec-WebSocket-Key**, **Sec-WebSocket-Protocol**, **Sec-WebSocket-Version**. 

What is **Sec-WebSocket-Key** header? It's an unique key generated by client. Server needs it for generating **Sec-WebSocket-Accept** header.

According to official RFC and Wikipedia, **Sec-WebSocket-Accept** value is base64 encoded SHA-1 hash of **Sec-WebSocket-Key** combined with fixed UUID **258EAFA5-E914-47DA-95CA-C5AB0DC85B1**.

```ts
import { createHash } from 'node:crypto';

function createWsAcceptKey(wsKey: string): string {
    const uuid = '258EAFA5-E914-47DA-95CA-C5AB0DC85B11'; // constant UUID definied in WS RFC
    const dataToHash = wsKey + uuid

    return createHash('sha1')
        .update(Buffer.from(dataToHash))
        .digest('base64');
}
```

### Finalizing WebSocket handshake

Just send required headers: **Upgrade**, **Connection** and **Sec-WebSocket-Accept**. Remember about HTTP status code 101 (Switching Protocols) and body with extra blank line at the end.

```ts
function finalizeHandshake(res: ServerResponse, wsAcceptKey: string) {
    res.statusCode = 101;
    
    // set headers:
    res.setHeader('Upgrade', 'websocket');
    res.setHeader('Connection', 'Upgrade');
    res.setHeader('Sec-WebSocket-Accept', wsAcceptKey);
    
    res.write('\r\n');
    res.end();
}
```
